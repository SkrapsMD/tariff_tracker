<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tariff Map</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
      integrity="sha256-sA+e6VPn8j7Z4KJS2SXChv5PC+ZB6GJcrvBZFTPtg6k="
      crossorigin=""
    />
    <style>
      /* Make the map fill the browser window */
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Map container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet/dist/leaflet.js"
      integrity="sha256-nPLV+ZNJpOdaHSyk1y69RJAWhEvlDxUBHizqBAqLrF4="
      crossorigin=""
    ></script>

    <script>
      // 1) Initialize the map
      const map = L.map("map").setView([20, 0], 2); // roughly center on the globe

      // 2) Add a tile layer (OpenStreetMap for simplicity, or you could use a dark tile service)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      // 3) Fetch a GeoJSON file of world countries
      //    For a quick start, you can use one from GitHub or store your own in "world_countries.geojson".
      fetch("world_countries.geojson")
        .then((res) => res.json())
        .then((geojsonData) => {
          geojsonData.features.forEach((feature) => {
            feature.properties.ADMIN_LOWER = feature.properties.ADMIN.toLowerCase();
          });
          // 4) Create a Leaflet GeoJSON layer
          L.geoJSON(geojsonData, {
            onEachFeature: function (feature, layer) {
              // 5) Attach a click event to each country polygon
              layer.on("click", () => {
                const isoCode = feature.properties.ISO_A3;
                const lowerCountryName = feature.properties.ADMIN_LOWER;
                // Extract the country's name property from the GeoJSON
                // Adjust the property if your GeoJSON uses a different field
                const countryName = feature.properties.ADMIN;

                // Prompt the user for a new tariff rate
                const newTariffStr = prompt(`Enter new tariff for ${isoCode}:`, "0.1");
                if (newTariffStr === null) {
                  // User clicked cancel
                  return;
                }

                // Convert string to float
                const newTariffValue = parseFloat(newTariffStr);
                if (isNaN(newTariffValue)) {
                  alert("Invalid tariff value.");
                  return;
                }

                // 6) Construct the request body for your FastAPI endpoint
                //    This assumes your endpoint expects:
                //       { new_tariffs: { [countryName]: <float> }, pass_through: <float> }
                const requestData = {
                  new_tariffs: { [countryName]: newTariffValue },
                  pass_through: 1.0,
                };

                // 7) Send a POST request to your API endpoint
                //    Adjust the URL if your FastAPI server is running on a different origin/port
                fetch("/api/calculate_price_effects", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(requestData),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    // data should have a "results" array like [{ country: "...", price_effect: ... }, ...]
                    console.log("Server response:", data);
                    if (data.results && data.results.length) {
                      const priceEffect = data.results[0].price_effect.toFixed(2);
                      alert(
                        `Price effect for ${countryName}: ${priceEffect}%`
                      );
                    } else {
                      alert("No price effect data returned.");
                    }
                  })
                  .catch((err) => {
                    console.error("API error:", err);
                    alert("Error calling the API.");
                  });
              });
            },
          }).addTo(map);
        })
        .catch((err) => {
          console.error("Error loading GeoJSON:", err);
          alert("Could not load the country map data.");
        });
    </script>
  </body>
</html>
